{% extends "base.html" %}

{% block content %}


<div class="col-xl-12">
    <div class="card">
        <div class="card-body">
            <div class="col-lg-12 text-right">
              <button type="button" class="btn btn-warning waves-effect waves-light" data-toggle="modal" data-target="#exampleModalLong">
                Add Action
            </button>
               
                </div>
                <br>
            <h4 class="card-title">ACTIONS</h4>
            <br>

            <ul class="nav nav-tabs nav-justified mb-3">
                <li class="nav-item">
                    <a href="#manual" data-toggle="tab" aria-expanded="true" class="nav-link active">
                        <i class="mdi mdi-home-variant d-lg-none d-block"></i>
                        <!-- Display the count of manual actions that are not completed -->
                        <span class="d-none d-lg-block">Manual Actions 
                          <span class="badge badge-danger badge-pill">{{ manual_not_completed_count }}</span></span>                            
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#automatic" data-toggle="tab" aria-expanded="false" class="nav-link ">
                        <i class="mdi mdi-account-circle d-lg-none d-block"></i>
                        <span class="d-none d-lg-block">Automatic Actions <span class="badge badge-danger badge-pill">{{ auto_count }}</span></span></span>
                        
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#allaction" data-toggle="tab" aria-expanded="false" class="nav-link ">
                        <i class="mdi mdi-account-circle d-lg-none d-block"></i>
                        <span class="d-none d-lg-block">Action History </span>
                        
                    </a>
                </li>
            </ul>
        
    <div class="tab-content">
        <div class="tab-pane show active" id="manual">
            <div class="row">
                <div class="col-12">
                        <div class="card-body">
                            
                        

                        <!-- Update Actions Form -->
                        <form method="post" action="{% url 'collection' %}">
                          {% csrf_token %}
                          <table id="basic-datatable" class="table">
                              <thead>
                                  <tr>
                                      <th>Completed</th>
                                      <th>Action Date</th>
                                      <th>Action Type</th>
                                      <th>Action Amount</th>
                                      <th>Client ID</th>
                                      <th>Client Name</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  {% for action in actions %}
                                  {% if not action.completed and action.type == 'manual' %}
                                  <tr style="background-color: #f2dede;">
                                      <td class="text-center" style="width: 10px;">
                                          <input type="checkbox" name="completed_actions" value="{{ action.id }}">
                                      </td>
                                      <td>{{ action.action_date }}</td>
                                      {% if action.action_type == 'SMS' %}
                                      <td>
                                          <button type="button" class="btn btn-warning waves-effect waves-light" style="width: 150px;">
                                              <i class="mdi mdi-message"></i> {{ action.action_type }}
                                          </button>
                                      </td>
                                      {% elif action.action_type == 'Call' %}
                                      <td>
                                          <button type="button" class="btn btn-success waves-effect waves-light" style="width: 150px;">
                                              <i class="mdi mdi-phone"></i> {{ action.action_type }}
                                          </button>
                                      </td>
                                      {% elif action.action_type == 'Email' %}
                                      <td>
                                          <button type="button" class="btn btn-danger waves-effect waves-light" style="width: 150px;">
                                              <i class="mdi mdi-gmail"></i> {{ action.action_type }}
                                          </button>
                                      </td>
                                      {% endif %}
                                      <td>Rs {{ action.action_amount }}</td>
                                      <td>{{ action.short_name.short_name }}</td>
                                      <td><a href="{% url 'client_profile' client_id=action.short_name.id %}">{{ action.short_name }}</a></td>
                                  </tr>
                                  {% endif %}
                                  {% endfor %}
                              </tbody>
                          </table>
                          {% if manual_not_completed_count > 0 %}
                          <button type="submit" name="update_actions" class="btn btn-success btn-sm waves-effect waves-light">Complete Actions</button>
                          {% endif %}
                        </form>

                        
                              
                        </div> <!-- end card body-->
                 
                </div><!-- end col-->
            </div>
            <!-- end row-->
        
        </div>
        <div class="tab-pane " id="automatic">
            <div class="row">
                <div class="col-12">
                        <div class="card-body">
                            
                            
                                <table id="basic-datatable" class="table">
                                  <thead>
                                    <tr>
                                      
                                      <th>Action Date</th>
                                      <th>Action Type</th>
                                      <th>Action Amount</th>
                                      <th>Client ID</th>
                                      <th>Client Name</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {% for action in actions %}
                                    {% if action.type == 'auto'  %}
                                    <tr style="{% if action.completed %}background-color: #dff0d8;
                                    {% elif not action.completed %}background-color: #fcf8e3;{% endif %}">
                                      
                                      <td>{{ action.action_date }}</td>
                                      {% if action.action_type == 'SMS' %}
                                      <td>
                                        <button type="button" class="btn btn-warning waves-effect waves-light" style="width: 150px;">
                                          <i class="mdi mdi-message"></i> {{ action.action_type }}
                                        </button>
                                      </td>
                                      {% elif action.action_type == 'Call' %}
                                      <td>
                                        <button type="button" class="btn btn-success waves-effect waves-light" style="width: 150px;">
                                          <i class="mdi mdi-phone"></i> {{ action.action_type }}
                                        </button>
                                      </td>
                                      {% elif action.action_type == 'Email' %}
                                      <td>
                                        <button type="button" class="btn btn-danger waves-effect waves-light" style="width: 150px;">
                                          <i class="mdi mdi-gmail"></i> {{ action.action_type }}
                                        </button>
                                      </td>
                                      {% endif %}
                                      <td>Rs {{ action.action_amount }}</td>
                                      <td>{{ action.short_name.short_name }}</td>
                                      <td><a href="{% url 'client_profile' client_id=action.short_name.id %}">{{ action.short_name }}</a></td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                  </tbody>
                                </table>
                              
                              
                        </div> <!-- end card body-->
                 
                </div><!-- end col-->
            </div>
            <!-- end row-->
        </div>
        <div class="tab-pane" id="allaction">
            <div class="row">
                <div class="col-12">
                        <div class="card-body">
                            
                            
                                <table id="basic-datatable" class="table">
                                  <thead>
                                    <tr>
                                      
                                      <th>Action Date</th>
                                      <th>Action Type</th>
                                      <th>Action Amount</th>
                                      <th>Client ID</th>
                                      <th>Client Name</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {% for action in actions %}
                                    {% if action.completed %}
                                    <tr style="background:#dff0d8">
                                     
                                      <td>{{ action.action_date }}</td>
                                      {% if action.action_type == 'SMS' %}
                                      <td>
                                        <button type="button" class="btn btn-warning waves-effect waves-light" style="width: 150px;">
                                          <i class="mdi mdi-message"></i> {{ action.action_type }}
                                        </button>
                                      </td>
                                      {% elif action.action_type == 'Call' %}
                                      <td>
                                        <button type="button" class="btn btn-success waves-effect waves-light" style="width: 150px;">
                                          <i class="mdi mdi-phone"></i> {{ action.action_type }}
                                        </button>
                                      </td>
                                      {% elif action.action_type == 'Email' %}
                                      <td>
                                        <button type="button" class="btn btn-danger waves-effect waves-light" style="width: 150px;">
                                          <i class="mdi mdi-gmail"></i> {{ action.action_type }}
                                        </button>
                                      </td>
                                      {% endif %}
                                      <td>Rs {{ action.action_amount }}</td>
                                      <td>{{ action.short_name.short_name }}</td>
                                      <td><a href="{% url 'client_profile' client_id=action.short_name.id %}">{{ action.short_name }}</a></td>
                                    </tr>
                                    {% endif %}
                                    {% endfor %}
                                  </tbody>
                                </table>
                                
                              
                        </div> <!-- end card body-->
                 
                </div><!-- end col-->
            </div>
            <!-- end row-->
        </div>
    </div>
        </div> <!-- end card-body-->
    </div> <!-- end card-->
</div> <!-- end col -->

<!-- end row-->
<div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle"> <i class="mdi mdi-format-list-triangle"></i> Action  </h5>
              <button type="button" class="close waves-effect waves-light" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body">
              <!-- Add Action Form -->
              <form method="post" action="{% url 'collection' %}">
                {% csrf_token %}
                
                
                <div class="form-group">
                  <label for="example-readonly">Action Date</label>
                  <input type="text" id="example-readonly" class="form-control" readonly="" value="Readonly value">
                </div>
                <label>Action Type </label><br>
                <div class="btn-group btn-group-toggle waves-effect waves-light" data-toggle="buttons">
                  <label class="btn btn-warning waves-effect waves-light">
                      <input type="radio" name="options" id="option1"
                          checked> SMS <i class="mdi mdi-message"></i>
                  </label>
                  <label class="btn btn-success waves-effect waves-light">
                      <input type="radio" name="options" id="option2">
                      Call <i class="mdi mdi-phone"></i>
                  </label>
                  <label class="btn btn-danger waves-effect waves-light">
                      <input type="radio" name="options" id="option3">
                      Email <i class="mdi mdi-gmail"></i>
                  </label>
              </div>
              <br>
              <br>
              <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

              <div class="form-group">
                <label>Client</label>
                <select id="clientSelect" class="form-control" data-toggle="select2">
                    <option value="">Select</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Bill No:</label>
                <select id="billSelect" class="form-control" data-toggle="select2">
                    <option value="">Select</option>
                </select>
            </div>
            
            <script>
              $(document).ready(function () {
                  var clientSelect = $('#clientSelect');
                  var billSelect = $('#billSelect');
          
                  // Fetch client data
                  $.ajax({
                      url: '/sales/get_client_names/',
                      dataType: 'json',
                      success: function (data) {
                          $.each(data.client_data, function (index, client) {
                              clientSelect.append('<option value="' + client.account_name + '">' + client.account_name + '</option>');
                          });
          
                          // Define a function to handle the change event
                          function handleClientChange() {
                              var selectedClient = clientSelect.val();
                              billSelect.empty();
          
                              // Find the selected client's data
                              var selectedClientData = data.client_data.find(function (client) {
                                  return client.account_name === selectedClient;
                              });
          
                              // Populate bill numbers in the bills dropdown
                              if (selectedClientData) {
                                  var billNumbers = selectedClientData.bill_numbers || [];
                                  $.each(billNumbers, function (index, billNumber) {
                                      billSelect.append('<option value="' + billNumber + '">' + billNumber + '</option>');
                                  });
                              }
                          }
          
                          // Check if the change event is already bound before binding it
                          if (!clientSelect.data('event-bound')) {
                              // Bind the change event to the handler
                              clientSelect.on('change', handleClientChange);
                              // Mark the event as bound
                              clientSelect.data('event-bound', true);
                          }
                      },
                      error: function (error) {
                          console.error("Error fetching client data:", error);
                      }
                  });
              });
          </script>
          
          
          

            
            
            
            <div class="form-group">
              <label for="example-readonly">Action Amount:</label>
              <input type="text" id="example-readonly" class="form-control" readonly="" value="Readonly value">
            </div>
            <label>Completed: <input clas="mt-3" type="checkbox" checked data-toggle="switchery" data-color="#4BB543" data-size="small"/></label>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-secondary waves-effect waves-light" data-dismiss="modal">Close</button>
              <button type="submit" name="add_action" class="btn btn-primary waves-effect waves-light">Update Action</button>
          </div>
        </form>
      </div>
  </div>
</div>

{% endblock content %}